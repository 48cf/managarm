
package managarm.posix;

enum Errors {
	SUCCESS = 0;
	DEAD_FORK = 6;
	ILLEGAL_REQUEST = 4;
	FILE_NOT_FOUND = 1;
	ACCESS_DENIED = 2;
	ALREADY_EXISTS = 3;
	NO_SUCH_FD = 5;
}

enum ClientRequestType {
	INIT = 7;
	FORK = 8;
	EXEC = 1;
	OPEN = 2;
	READ = 3;
	WRITE = 4;
	CLOSE = 5;
	DUP2 = 6;
	HELFD_ATTACH = 10;
	HELFD_CLONE = 11;
};

enum OpenFlags {
	CREAT = 1;
};

enum OpenMode {
	REGULAR = 1;
	HELFD = 2;
};

message ClientRequest {
	optional ClientRequestType request_type = 1;
	
	// used by INIT, EXEC and OPEN
	optional string path = 2;

	// used by OPEN
	optional int32 flags = 3;
	optional int32 mode = 10;

	// used by READ, WRITE, CLOSE, DUP2, HELFD_ATTACH, HELFD_CLONE
	optional int32 fd = 4;

	// used by DUP2
	optional int32 newfd = 7;

	// used by READ
	optional int32 size = 5;

	// used by WRITE
	optional bytes buffer = 6;

	// used by FORK
	optional uint64 child_sp = 8;
	optional uint64 child_ip = 9;
}

message ServerResponse {
	// return of ALL
	optional int32 error = 3;

	// return of OPEN
	optional int32 fd = 1;

	// return of READ
	optional bytes buffer = 2;
}

